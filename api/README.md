# Kunilo API

This is the *Kunilo API* source code.

## Development
Be sure [Docker](https://docker.com/) and
[Make](https://www.gnu.org/software/make/) are installed before proceeding.
Docker is used to provision a local L\*MP stack using Nginx, MySQL, PHP (fpm),
and MailHog containers. Make is used to coordinate build actions.

Build the api by calling `make build` from this directory. Build output is
placed in `./dist`. After the api is built, copy `./dist/env.example` to
`./dist/.env`. You may now launch the api and initialize the database.

Start the stack (and thus run the api) by calling `make start`.

Initialize the database by calling `make init-db`. Note: the MySQL service
must be running and accepting connections for initialization to succeed.

The stack may be stopped by calling `make stop`.

When running, the api is available at
[http://localhost:8080](http://localhost:8080).

Emails generated by api are captured by MailHog and are available at
[http://localhost:8025](http://localhost:8025).

### Makefile Targets

The `Makefile` offers the following targets:

  * `start` - start service containers
  * `stop` - stop service containers
  * `build` - build the project (default)
  * `init-db` - initialize the database (the mysql service must be running)
  * `clean` - delete build artifacts
  * `purge` - delete build artifacts and tear-down containers

## Deploy

The following software/services are required to host the api:

 * A web server (e.g. Nginx or Apache)
 * MySQL 8.0.1 or greater
 * PHP 7.4 or greater
 * Outbound SMTP access

Follow these steps to deploy the api. Please carefully read through all of the
steps first as it may be necessary for you to modify the example commands to
suit your hosting environment.

  1. Execute `make build` to build the api.

         make build

  2. Copy the contents of `./dist` to the hosting server. See the Server
  Configuration section that follows for path requirements.

         tar czf kunilo-api.tgz -C dist .
         scp kunilo-api.tgz username@remote-host:
         ssh username@remote-host 'tar zxf kunilo-api.tgz -C /var/www'


  3. On the hosting server, copy `env.example` to `.env` and edit the
   configuration values to reflect your production environment.

         ssh username@remote-host
         cd /var/www
         cp env.example .env
         vi .env

  4. Create the apiâ€™s database and a dedicated user to access it. While these
  example commands use `password` for the user's password, you should choose
  something more secure and update `.env` accordingly.

         CREATE DATABASE kunilo;
         CREATE USER 'kunilo'@'localhost' IDENTIFIED BY 'password';
         GRANT SELECT, INSERT, UPDATE, DELETE ON kunilo.* TO 'kunilo'@'localhost';

  5. Seed the database with `db/schema.sql`.

         mysql kunilo < db/schema.sql

### Server Configuration

All api requests should be handled by `public/index.php`. If you're using Nginx,
this can be accomplished by setting `SCRIPT_FILENAME` to the index file
directly.

    fastcgi_param SCRIPT_FILENAME /var/www/public/index.php;

If you're serving the api with Apache, this can be accomplished with
`mod_rewrite`.

    DocumentRoot "/var/www/public"

    <Directory "/var/www/public">
      RewriteEngine on
      RewriteCond %{REQUEST_FILENAME} !-f
      RewriteCond %{REQUEST_FILENAME} !-d
      RewriteRule ^(.*)$ /index.php
    </Directory>

